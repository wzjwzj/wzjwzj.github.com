
<!DOCTYPE html>
<!--[if IE 7 ]>    <html lang="zh-CN" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="zh-CN" class="ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="zh-CN"> <!--<![endif]-->

<head>
  <meta charset="UTF-8">
  <!--[if IE 8 ]><meta http-equiv="X-UA-Compatible" content="IE=7"><![endif]-->

  <title>kiwi_info</title>
  
  
  <meta name="author" content="孤月谁明">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon -->
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/themes/twitter/css/style.min.css">
  <!--link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet"-->
  <link rel="stylesheet" href="/assets/font-awesome-4.0.3/css/font-awesome.min.css">
  <!--link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"-->
  <!--link rel="stylesheet" href="/assets/prettify/prettify.css"-->
  
  <!-- Scripts -->
  <script type="text/javascript" src="/assets/themes/twitter/js/jquery-1.10.1.min.js"></script>
  <script type="text/javascript" src="/assets/jquery-ui/js/jquery-ui-1.10.4.custom.min.js"></script>
  <link   rel="stylesheet"      href="/assets/jquery-ui/css/smoothness/jquery-ui-1.10.4.custom.min.css">

  	
   <script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		config: ["MMLorHTML.js"],
		tex2jax: {
			inlineMath: [ ['$','$'], ['\\(','\\)'] ],
			displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
			processEscapes:true
  		},
  
  		jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML"],
  		extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js"],
  		TeX: {
	  
			extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js","color.js","cancel.js"],
			equationNumbers: { autoNumber: "AMS" }
  		},
		styles: {
  			".MathJax_Display": {
    				"overflow-x": "auto",
    				"overflow-y": "hidden"
  			}
		}
	});
   </script>
   <script type='text/javascript' src='http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  

  

  
  <script type="text/javascript" src="/assets/syntaxhighlighter/scripts/shCore.js"></script>
  <script type="text/javascript" src="/assets/syntaxhighlighter/scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="/assets/syntaxhighlighter/scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="/assets/syntaxhighlighter/scripts/shBrushFortran.js"></script>
  <link type="text/css" rel="stylesheet" href="/assets/syntaxhighlighter/styles/shCoreDefault.css"/>
  

  <style>blockquote{ margin-start:20px; -webkit-margin-start: 20px; -moz-margin-start: 20px; -o-margin-start: 20px; -ms-margin-start: 20px; margin-end:0px; -webkit-margin-end: 0px; -moz-margin-end: 0px; -o-margin-end: 0px; -ms-margin-end: 0px;}table,th,td,tr{ background-color:white ; text-align:left;width:auto;padding-left:20px;}</style>

</head>

<body>

  <div id="wrap">
    <header id="top">
      <!-- Navigation Bar -->
      <nav id="navbar">
        <ul>
          
          <li>
            <a href="/" rel="nofollow" title="首页">首页</a>
          </li>
          <li>
            <a href="/archives.html" rel="nofollow" title="archives">归档</a>
          </li>
          <li>
            <a href="/messages.html" rel="nofollow" title="留言板">留言板</a>
          </li>
	  
	  <li>
	  <a href="/links.html" rel="nofollow" title="链接">链接</a>
	  </li>
	  
          <li>
            <a href="/about.html" rel="nofollow" title="关于">关于</a>
	  </li>

          <li>
	  <a href="/lino.html" rel="nofollow" title="便签">便签</a>
	  </li>

	  <li>
	  <a href="/gallery.html" rel="nofollow" title="相册">相册</a>
	  </li>

	  <li>
	  <a href="/slide.html" rel="nofollow" title="PPT">PPT</a>
	  </li>
	  
	  <li>
	  <a href="/docs/" rel="nofollow" title="docs">docs</a>
	  </li>

          <li>
            <a href="/rss.xml" rel="nofollow" title="订阅 RSS"><i class="fa fa-rss fa-2"></i></a>
          </li>
	  <li >
            <i id="icon-resize" class="fa fa-expand fa-2"></i>
          </li>
        </ul>
      </nav>
    </header>

    <section id="main">

      <!-- Sidebar -->
      <aside id="sidebar">
        <section id="search-box">
	 
<CENTER>
<!--img src="/assets/themes/twitter/img/google_search.png" border="0" alt="Google" align="absmiddle" style="padding-bottom:20px" /--> 
<!--FONT class='wdnx' ><B>惟德乃兴</B></FONT-->

<form  method="get" action="/gsearch.html">
  <input  type="text"   class="search-query" name="q"   placeholder="谷歌引擎搜索"></input>   
  <!--button type="submit" class="search-button" ><i class="icon-search"></i></button-->
</form>

<form  method="get" action="/search.html">
  <input  type="text"   class="search-query" name="q"   placeholder="站内正则搜索"></input>   
  <!--button type="submit" class="search-button" ><i class="icon-search"></i></button-->
</form>

<form  method="get" action="/dict.html">
  <input  type="text"   class="search-query" name="q"   placeholder="dict.cn 海词"></input>   
  <!--button type="submit" class="search-button" ><i class="icon-search"></i></button-->
</form>

<form id="glosbe" name="glosbe"  method="get" action="/glosbe.html"> 
  <input  type="text"   id="phrase"  name="phrase"  placeholder="dictionary" class="search-query">  
  <select name="from" onchange='set_item_from( )'>
    <option value="deu" >deutsch</option>
    <option value="eng" >english</option>
    <option value="zho" >汉语</option>
  </select>
  <select name="dest" onchange='set_item_dest( )' >
    <option value="zho">汉语</option>
    <option value="eng">english</option>
    <option value="deu">deutsch</option>
  </select> 
  <!--input  type="text"   id="phrase"  name="phrase"  placeholder="dictionary" class="search-query"-->  
  <!--button type="submit" class="search-button" ><i class="icon-search"></i></button-->
</form> 
<div id="keyboard" style="display:none; "> 
	<a href="javascript:addSpecChar('ä')" class="btn">ä</a> 
	<a href="javascript:addSpecChar('Ä')" class="btn">Ä</a> 
	<a href="javascript:addSpecChar('ö')" class="btn">ö</a> 
	<a href="javascript:addSpecChar('Ö')" class="btn">Ö</a> 
	<a href="javascript:addSpecChar('ü')" class="btn">ü</a> 
	<a href="javascript:addSpecChar('Ü')" class="btn">Ü</a> 
	<a href="javascript:addSpecChar('ß')" class="btn">ß</a> 
	<a href="javascript:addSpecChar('ẞ')" class="btn">ẞ</a> 
</div>
</CENTER>


<SCRIPT language=JavaScript>
  function showhidekeyboard(){
    if($('#glosbe select[name="from"]').val() == 'deu' ){
	$('#keyboard').css("display","inline-block");
    }else{
	$('#keyboard').css("display","none");
    }
  }
  if ( !sessionStorage.getItem("from") ) {  
	sessionStorage.setItem("from", "deu");
        $('#glosbe select[name="from"]').val("deu");
  }else{
	$('#glosbe select[name="from"]').val(sessionStorage.getItem("from"));
  }
  showhidekeyboard();
  if ( !sessionStorage.getItem("dest") ) {  
	sessionStorage.setItem("dest", "zho");
        $('#glosbe select[name="dest"]').val("zho");
  }else{
        $('#glosbe select[name="dest"]').val(sessionStorage.getItem("dest"));
  }
  function set_item_from( ){
	sessionStorage.setItem('from', $('#glosbe select[name="from"]').val());
	showhidekeyboard();
  }
  function set_item_dest( ){
	sessionStorage.setItem('dest', $('#glosbe select[name="dest"]').val());
  }
  function addSpecChar(NewCode) {
    document.glosbe.phrase.value += ''+NewCode+''; 
    var t=$("#phrase").val(); $("#phrase").val("").focus().val(t);
  };
</SCRIPT>


	</section>
	<section>
	 <div style="padding:22px 18px">
	 <a class=social style="background-image: url('/images/social/Icon_Seminar.jpg');"  target="_blank" href="http://seismo.geo.uni-potsdam.de/upseismo/wiki/SeminarTalks" title="Seminar Talks">social</a>
	 <a class=social style="background-image: url('/images/social/mail-icon.jpg');"  target="_blank" href="https://coesite.geo.uni-potsdam.de/src/login.php" title="Email Coesite">social</a>
	 <a class=social style="background-image: url('/images/social/calligraphy.png');"  target="_blank" href="/demos/calligraphy.html" title="每日一字">calligraphy</a>
	 <a class=social style="background-image: url('/images/social/gmt_nav.gif');"  target="_blank" href="http://gmt.soest.hawaii.edu/doc/5.1.0/index.html" title="gmt">gmt</a>
	 <a class=social style="background-image: url('/images/social/kiwi.png');"  target="_blank" href="http://kinherd.org/" title="kiwi tools">kiwi</a>
	 </div>
	</section>
	<!--toc>
	<div id="toc_wraper" style="display:none">
	<section>
	   <a href="#"><i class="fa fa-list fa-2"></i> 目录 </a>
	   <div class="toc">
	</section>
	</div-->
	
	<!--toc-->
	

	<!--widget default include  -->
	
	   
  <section  class="active"><a href="/archive.html" title="查看所有文章"><i class="fa fa-file-text fa-2"></i> 最近发表</a>
<span title="文章总数">18</span>
<ul>

  <li><a href="/blog/2014/04/16/abic0" title="查看《ABIC0》">ABIC0</a></li>

  <li><a href="/blog/2014/03/03/ABIC" title="查看《ABIC》">ABIC</a></li>

  <li><a href="/blog/2014/02/25/chinese-food-recipe" title="查看《菜单》">菜单</a></li>

  <li><a href="/blog/2014/02/17/tar" title="查看《[转]tar 压缩解压缩命令详解》">[转]tar 压缩解压缩命令详解</a></li>

  <li><a href="/blog/2014/02/09/pjax" title="查看《[转]Pjax是什么以及为什么推荐大家用》">[转]Pjax是什么以及为什么推荐大家用</a></li>

  <li><a href="/blog/2014/02/08/nationalparks-in-deutschland" title="查看《测试谷歌地图:德国国家公园》">测试谷歌地图:德国国家公园</a></li>

  <li><a href="/blog/2014/01/20/kiwi_info" title="查看《kiwi_info》">kiwi_info</a></li>

  <li><a href="/blog/2014/01/14/smalltool" title="查看《small tools,widgets or applets list》">small tools,widgets or applets list</a></li>

  <li><a href="/blog/2014/01/12/haskell-on-ubuntu" title="查看《haskell on ubuntu》">haskell on ubuntu</a></li>

  <li><a href="/blog/2014/01/11/command_pool" title="查看《常用命令示例》">常用命令示例</a></li>

  <li><a href="/blog/2014/01/08/amssymbols" title="查看《AMSsymbols》">AMSsymbols</a></li>

  <li><a href="/blog/2013/12/18/build-repository-with-dropbox" title="查看《用dropbox虚拟github建立私有仓库》">用dropbox虚拟github建立私有仓库</a></li>

  <li><a href="/blog/2013/12/17/scripts" title="查看《一些示例脚本存档》">一些示例脚本存档</a></li>

  <li><a href="/blog/2013/12/15/test-self-def-input" title="查看《测试自定义输入》">测试自定义输入</a></li>

  <li><a href="/blog/2013/12/14/problems-refer-cygwin" title="查看《cygwin下个人使用过程中所遇问题汇总》">cygwin下个人使用过程中所遇问题汇总</a></li>

</ul>
</section>
  <section ><a href="/categories.html" title="查看所有分类"><i class="fa fa-folder-open fa-2"></i> 文章分类</a>
<span title="分类总数">8</span>
<ul>

  <li><a href="/categories.html#uncategorized-ref" rel="nofollow">uncategorized (8)</a></li>

  <li><a href="/categories.html#info-ref" rel="nofollow">info (5)</a></li>

  <li><a href="/categories.html#git-ref" rel="nofollow">git (1)</a></li>

  <li><a href="/categories.html#programming-ref" rel="nofollow">programming (1)</a></li>

  <li><a href="/categories.html#dropbox-ref" rel="nofollow">dropbox (1)</a></li>

  <li><a href="/categories.html#study-ref" rel="nofollow">study (1)</a></li>

  <li><a href="/categories.html#旅游-ref" rel="nofollow">旅游 (1)</a></li>

  <li><a href="/categories.html#unix-ref" rel="nofollow">unix (1)</a></li>

</ul>
</section>
  <section ><a href="/tags.html" title="查看所有标签"><i class="fa fa-tags fa-2"></i> 标签云</a>
<span title="标签总数">19</span>
<div id="tag-cloud">


  
  <a href="/tags.html#info-ref" rel="nofollow" style="font-size: 18pt; color: #000;">info</a>

  
  <a href="/tags.html#git-ref" rel="nofollow" style="font-size: 9pt; color: #999;">git</a>

  
  <a href="/tags.html#cygwin-ref" rel="nofollow" style="font-size: 9pt; color: #999;">cygwin</a>

  
  <a href="/tags.html#error-ref" rel="nofollow" style="font-size: 9pt; color: #999;">error</a>

  
  <a href="/tags.html#test-ref" rel="nofollow" style="font-size: 9pt; color: #999;">test</a>

  
  <a href="/tags.html#script-ref" rel="nofollow" style="font-size: 9pt; color: #999;">script</a>

  
  <a href="/tags.html#code-ref" rel="nofollow" style="font-size: 9pt; color: #999;">code</a>

  
  <a href="/tags.html#dropbox-ref" rel="nofollow" style="font-size: 9pt; color: #999;">dropbox</a>

  
  <a href="/tags.html#github-ref" rel="nofollow" style="font-size: 9pt; color: #999;">github</a>

  
  <a href="/tags.html#AMS-ref" rel="nofollow" style="font-size: 9pt; color: #999;">AMS</a>

  
  <a href="/tags.html#symbols-ref" rel="nofollow" style="font-size: 9pt; color: #999;">symbols</a>

  
  <a href="/tags.html#mathjax-ref" rel="nofollow" style="font-size: 9pt; color: #999;">mathjax</a>

  
  <a href="/tags.html#latex-ref" rel="nofollow" style="font-size: 9pt; color: #999;">latex</a>

  
  <a href="/tags.html#tex-ref" rel="nofollow" style="font-size: 9pt; color: #999;">tex</a>

  
  <a href="/tags.html#command-ref" rel="nofollow" style="font-size: 9pt; color: #999;">command</a>

  
  <a href="/tags.html#haskell-ref" rel="nofollow" style="font-size: 9pt; color: #999;">haskell</a>

  
  <a href="/tags.html#cabal-ref" rel="nofollow" style="font-size: 9pt; color: #999;">cabal</a>

  
  <a href="/tags.html#ghc-ref" rel="nofollow" style="font-size: 9pt; color: #999;">ghc</a>

  
  <a href="/tags.html#installation-ref" rel="nofollow" style="font-size: 9pt; color: #999;">installation</a>

</div>
</section>

  <!--section id="xiami" style="padding-top:10px; height:275px; overflow-y:hidden;"><script type="text/javascript" src="http://www.xiami.com/widget/player-multi?uid=30536045&sid=1771893720,1771286689,1771179817,1460646,3418644,2178964,1275039,&width=250&height=320&mainColor=aaaaaa&backColor=e6e6e6&autoplay=0&mode=js"></script>
</section-->

<div id="fixed-container">
  <section id="rlist"><a href="#"><i class="fa fa-code fa-2"></i> 代码仓库</a>
<ul>
  <li><a href="http://github.com/liberize/liberize.github.com">本博客源码</a></li>
  <!--
  <li><a href="http://github.com/liberize/rhythmbox-doubanfm-plugin">Rhythmbox 豆瓣 FM 插件</a></li>
  <li><a href="http://github.com/liberize/rhythmbox-osdlyrics-plugin">Rhythmbox 歌词插件</a></li>
  -->
</ul>
</section>
  <section id="llist"><a href="#"><i class="fa fa-link fa-2"></i> 友情链接</a>
<ul>
  <li><a href="https://github.com/Shopify/liquid/wiki/Liquid-for-Designers" target="_blank" rel="nofollow">Liquid 模板引擎</a></li>
  <li><a href="http://jekyllrb.com/" target="_blank" rel="nofollow">Jekyll 静态博客生成器</a></li>
</ul>
</section>
  <section id="clist"><a href="#"><i class="fa fa-heart fa-2"></i> 与我联系</a>
<div id="contacts-list">
  <a href="mailto:wzjwzj@mail.ustc.edu.cn" target="_blank" rel="nofollow" title="Gmail">
    <i class="fa fa-envelope fa-3"></i>
  </a>
  <a href="http://wzjwzj.github.io/" target="_blank" rel="nofollow" title="Github">
    <i class="fa fa-github fa-3"></i>
  </a>
  <a href="http://wzjwzj.github.io/" target="_blank" rel="nofollow" title="新浪微博">
    <i class="fa fa-weibo fa-3"></i>
  </a>
  <a href="https://sites.google.com/site/guyueshuiming/" target="_blank" rel="nofollow" title="Google+">
    <i class="fa fa-google-plus fa-3"></i>
  </a>
  <a href="http://wzjwzj.github.io/" target="_blank" rel="nofollow" title="Twitter">
    <i class="fa fa-twitter fa-3"></i>
  </a>
  <a href="http://wzjwzj.github.io/" target="_blank" rel="nofollow" title="Facebook">
    <i class="fa fa-facebook-square fa-3"></i>
  </a>
</div>
</section>
</div>


	
      </aside>
      <!-- Main Content -->
      <div id="main-inner">
        <div id="loader"><img src="/assets/themes/twitter/img/loading.gif" alt="请稍侯"></div>
        <div id="main-content">
          
<section id="content">
  <article class="post">

    <header>
      <h1>kiwi_info</h1>
    </header>

    <section>
      <div class="post-extra">
        <div class="pull-left">
	   <span>20 January 2014  <a href="https://github.com/wzjwzj/wzjwzj.github.com/edit/master/_posts/2014-01-20-kiwi_info.md">编辑本文</a></span>
        </div>
	
      </div>
      <p>Kiwi info:</p>

<table style="border:none;">
<thead>
<tr>
<th>GIT </th>
<th> repository </th>
<th style="text-align:left;"> branch</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> kiwi       </td>
<td style="text-align:left;"> master<br>kiwi_asa<br><strong style="padding-left:30px">kiwi_asa_dev</strong> <br><span style="padding-left:60px">kiwi_asa_bug</span></td>
</tr>
</tbody>
</table>




<!--end_excerpt-->


<p><ul>
 <li>
 <ul>
  <li><a href="#an.example">an example</a></li>
  <li><a href="#set_source_location">set_source_location</a></li>
  <li><a href="#set_source_params_vs">set_source_params_vs</a></li>
  <li><a href="#psm_to_discretize_eikonal_modify">psm_to_discretize_eikonal_modify</a></li>
  <li><a href="#how.normalized.work.">how normalized work.</a></li>
  <li><a href="#set_inversion_method..lt..sa1....slipgen...nnls...svd..gt.">set_inversion_method &lt; sa1 |  slipgen | nnls | svd &gt;</a></li>
  <li><a href="#inversion.flow">inversion flow</a></li>
  <li><a href="#shortest_doi">shortest_doi</a></li>
  <li><a href="#cgrid.....egrid">cgrid 和 egrid</a></li>
  <li><a href="#time.reference">time reference</a></li>
 </ul>
 </li>
</ul>

</p>

<a name="an.example"></a>
<h2>an example</h2>

<pre><code class="brush: bash;">$cat test_sa1.sh
../minimizer &lt;&lt;EOF                             #   !  dip   .and.  strike  
  make clean                                   #
  set_effective_dt  1.0                        #  params ctrl discretize size
  set_source_location -F1 -L30.52/83.75        #  src coordinate
  set_source_params_vs eikonal_modify -F1 -M3.35E+18/180/45/-5 -L8000.0/5000.0r
  set_inversion_method slipgen -K0.8  #-G # -P0.5  # -G -S0.8  #  random generate slip-distribution 
  generate_static_data -Vn -F5.0/5.0/5.0       #  random generate obs coordinate
  output_static_data unfilter syn              #  calculate syn data
  plot source                                  #  
  sh plot_gmt.sh                               #  plot the figure
  cp plot_gmt.sh plot_gmt1.sh                  #
  cp a.ps a1.ps                                #   
  #---------------------------- 
  # quit                       #
  #-------inverse modelling----                #
  set_source_params_vs eikonal_modify -F1 -M3.35E+18/180/40/0 -L8000.0/5000.0r
  set_inversion_method sa1  -C1/1/0/1  -N100/1000/0 -R0.5/0 -S0.1 -T100/100
                         #  -Cv1/v2/v3/[/v4[v5]]   ! v1:iselect v2:ioptimize. v3: imisfit v4:ireduction: v5:istartmodel
  #quit
  r_st1 unfilter*.h5  # as filtered data      #  read data
  get_misfits_static                          #  get_result.
  output_static_data filter syn               #  output_result
  plot source                                 #  
  sh plot_gmt.sh                                  #  plot the figure
  mv plot_gmt.sh plot_gmt2.sh                         #  
  mv a.ps a2.ps                               #  
  quit                                        #  release memory
EOF

#h5dump -d /t_static_single_dataset/disp  unfilter*.h5 &gt; tmp.info
#h5dump -d /t_static_single_dataset/disp  filter*.h5   &gt;&gt; tmp.info
</code></pre>

<a name="set_source_location"></a>
<h2>set_source_location</h2>

<p>Set source spacial and Temporal ref point:  lat, lon, time.</p>

<p><strong>syntax:</strong></p>

<blockquote><p><code>set_source_location -F&lt;n&gt; -L&lt;lat&gt;/&lt;lon&gt; [-T&lt;time&gt;]</code></p></blockquote>

<p><strong>Parameters:</strong></p>

<blockquote><p>lat: latitude in degree.<br/>
lon: longitude in degree.<br/>
time: optional default: 0.</p></blockquote>

<p><strong>info</strong></p>

<blockquote><p><code>set_source_location( options_vs,ok )</code> in <code>minimizer_engine.f90</code>    <br/>
call  <code>psm_set_origin_and_time( psm,orign,ref_time)</code> in <code>parameterized_source.f90</code> <br/>
type(t_geo_coords),intent(in) :: origin  # <strong> coord in radius </strong></p>

<blockquote><p><code>call psm_set_default_constrains( psm )</code>   <br/>
 psm -> origin -> thickness:  <br/>
 <strong>default constrains: top: 1.5km, bottom:  thickness.</strong></p></blockquote></blockquote>

<a name="set_source_params_vs"></a>
<h2>set_source_params_vs</h2>

<p>set source parameters</p>

<p><strong>syntax:</strong></p>

<blockquote><p><code>set_source_params_vs &lt;clean|bilateral|eikonal|...&gt;  options</code></p></blockquote>

<p><strong>examples</strong></p>

<blockquote><p><code>set_source_params_vs eikonal_modify -F1 -M3.35E+18/180/45/-5 -L8000.0/5000.0r</code></p></blockquote>

<p><strong>info</strong></p>

<blockquote><p>call <code>parse_psm_params</code> => real:dimension(:) :: sourceparams<br/>
call <code>psm_set</code>  =></p>

<blockquote><p>call <code>psm_set_eikonal</code>
<strong><em>parameter of eikonal_modify:</em></strong>  <br/>
<code>-F :</code> <br/>
<code>[-R&lt;t0&gt;/&lt;x&gt;/&lt;y&gt;/&lt;z&gt;] :</code> <br/>
<code>[-M&lt;m&gt;/&lt;strike0&gt;[:&lt;strike1&gt;]/&lt;dip0&gt;[:&lt;dip1&gt;]/&lt;rake&gt;] :</code> <br/>
<code>[-B&lt;bord_shift_x/bord_shift_y&gt;] :</code> <br/>
<code>[-L&lt;bord-semi-length&gt;/[&lt;bord-semi-width&gt;][e|r]] :</code> default:   <br/>
<code>[-H&lt;nukl-shift-x/nukl-shift-y&gt;[c|r]] :</code> default:  <br/>
<code>[-V&lt;relative-rupture-velocity&gt;[/&lt;Vs&gt;]] :</code>  discretize 中用到 <br/>
<code>[-T&lt;rise_time&gt;] :</code> <br/>
<code>[-D&lt;nx_cutoff/ny_cutoff&gt;] : [2~HUGE(1)) : HUGE(1):</code> 只用来限制cgrid<br/>
<code>[-K] :</code></p></blockquote></blockquote>

<p><code>subroutine psm_set_eikonal_modify( psm, params, normalized, only_moment_changed)</code></p>

<p><code>params ==&gt; new_params ==&gt; psm_params_cache_eikonal_modfify</code>
<code>params ==&gt; new_params ==&gt; psm%params</code></p>

<a name="psm_to_discretize_eikonal_modify"></a>
<h2>psm_to_discretize_eikonal_modify</h2>

<p>discrete source</p>

<p><strong>info</strong></p>

<blockquote><p><code>subroutine psm_to_discretize_eikonal_modify( psm, shortest_doi,ok )</code></p></blockquote>

<p><strong><em>shortest_doi</em></strong></p>

<blockquote><p>shortest_doi
<code>set_effective_dt</code> => <code>effective_dt</code> (全局变量)  <br/>
<code>update_source_discrete</code>  <br/>
=> <code>call psm_to_discretize_wrap( list_node%psm, effective_dt, ok )</code></p>

<p><code>call psm_to_grid_size( psm, shortest_doi , ok )</code>   ： 计算 &Delta; Nx,Ny
<code>call psm_make_eikonal_grid( psm, psm%egrid, ok )</code>  :  分配空间，算rupture front
<code>call psm_downsample_grid(  psm, psm%egrid, psm%cgrid )</code> ： 下采样</p></blockquote>

<p>psm_to_grid_size:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran">1
2
3
4
5
6
7
8</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">delta</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="mf">0.</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="nv">shortest_doi</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="mi">400</span><span class="mf">0.</span><span class="p">)</span>   <span class="c">! delta_max=4km     ; delta_min= 100*0.25=25m</span>
<span class="nv">nxf</span><span class="o">=</span><span class="nb">floor</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="nv">bord_semi_x</span><span class="o">/</span><span class="nv">delta</span><span class="p">)</span>                 <span class="c">! 2.0*2265/50=90    ; </span>
<span class="nv">nyf</span><span class="o">=</span><span class="nb">floor</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="nv">bord_semi_y</span><span class="o">/</span><span class="nv">delta</span><span class="p">)</span>                 <span class="c">! 2.0*3150/50=126</span>
<span class="k">if</span><span class="p">(</span><span class="nv">nxf</span><span class="ow">.le.</span><span class="mi">1</span><span class="p">)</span> <span class="nv">nxf</span><span class="o">=</span><span class="mi">2</span> <span class="p">;</span> <span class="k">if</span><span class="p">(</span><span class="nv">bord_semi_x</span><span class="ow">.eq.</span><span class="mi">0</span><span class="p">)</span> <span class="nv">nxf</span><span class="o">=</span><span class="mi">1</span>  <span class="c">! line source</span>
<span class="k">if</span><span class="p">(</span><span class="nv">nyf</span><span class="ow">.le.</span><span class="mi">1</span><span class="p">)</span> <span class="nv">nyf</span><span class="o">=</span><span class="mi">2</span> <span class="p">;</span> <span class="k">if</span><span class="p">(</span><span class="nv">bord_semi_y</span><span class="ow">.eq.</span><span class="mi">0</span><span class="p">)</span> <span class="nv">nyf</span><span class="o">=</span><span class="mi">1</span>  <span class="c">! line source</span>
<span class="c">!print *,&#39;--&gt; nxf,nyf&#39; ,nxf,nyf  ! 90,126</span>
<span class="nv">delta_x</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nv">bord_semi_x</span><span class="o">/</span><span class="nv">nxf</span>  <span class="c">! </span>
<span class="nv">delta_y</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nv">bord_semi_y</span><span class="o">/</span><span class="nv">nyf</span>  <span class="c">!</span>
</pre></div>
</td></tr></table>


<p><font size="3" color="red" style="font-weight:bold;">  如果100计算则 delta 大概 = shortest_doi*50m, 目前采用的是比较笨的方法，egrid采用100m/s，cgrid采用rup_min_vs，反演格点采用cgrid，画图采用采用egrid，更为合理的是采用插值画图,避免使用egrid,但是因为边界的限制是随机的,任意的,计算边界采用了较小格点。先用bord_seim_x,bord_seim_y,effective_dt，100m/s 决定delta，然后考虑边界限制，获取几何边界，然后再一次计算delta.同时，算走时，用小格点精确点，还是需要用egrid</font></p>

<p><strong>期望更新：画图是采用基函数插值渲染, 第三步 psm_downsample_grid. 为egrid=>cgrid，应该弄个双向的，增加个插值cgrid=>egrid，ie: psm_resample_grid(decimate|stretch) </strong>.</p>

<a name="how.normalized.work."></a>
<h2>how normalized work.</h2>

<a name="set_inversion_method..lt..sa1....slipgen...nnls...svd..gt."></a>
<h2>set_inversion_method &lt; sa1 |  slipgen | nnls | svd &gt;</h2>

<p><strong> expected update </strong></p>

<blockquote><p>回调函数，设置统一接口</p></blockquote>

<p><strong> sa1 </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="bash"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</code></pre></div></td><td class="code"><div class="highlight"><pre>set_inversion_method sa1 -C0/0/0 -N10/100 -P0.25 -R0.5/0.25/0.5/0.5 -S0.1 -Ts0.03 -Tr0.95 -V
  <span class="o">[</span>-C&lt;iselect&gt;/&lt;ioptimize&gt;/&lt;imisfit&gt;/<span class="o">[</span>&lt;ireduction&gt;<span class="o">[</span>/&lt;imodel&gt;<span class="o">]]]</span>  : 
      iselect:   -1: one params 0: one fault 1: all params : 
      ioptimize: 0: GSA   1: ASA   2: MCMC : 
      imisfit:   0: MSE   1: BAYESIAN : 
      irecduction: 0:ASA  1: EXP 
      imodel: 0:UNIFORM  1: RANDOM 3: OLD 
  <span class="o">[</span>-L<span class="o">]</span>  : Layer model instead of halfspace
  <span class="o">[</span>-Mi&lt;0<span class="p">|</span>1<span class="p">|</span>2&gt;<span class="o">]</span>  : initial model: 0:uniform, 1:random, 2:old value,  have not implement.
  <span class="o">[</span>-N&lt;nsteps&gt;/&lt;niterations&gt;/<span class="o">[</span>&lt;init_ntiral&gt;<span class="o">]]</span>   : 
  <span class="o">[</span>-O<span class="o">]</span>  : output result each step to sa_out.hd5
  <span class="o">[</span>-P&lt;val&gt;<span class="o">]</span> : poisson ratio
  <span class="o">[</span>-R&lt;moment&gt;<span class="o">[</span>/&lt;rake&gt;<span class="o">[</span>/&lt;fronttime&gt;<span class="o">[</span>/&lt;risetime&gt;<span class="o">]]]]</span>:factor <span class="nb">set </span>range <span class="o">(</span>upper and lower boundary<span class="o">)</span>
  <span class="o">[</span>-Q&lt;val&gt;<span class="o">]</span> : quench factor -Q1.0
  <span class="o">[</span>-S<span class="o">]</span> : smooth_factor <span class="o">[</span>0.0 ~ +inf<span class="o">)</span>
  <span class="o">[</span>-Ts&lt;val&gt;<span class="o">]</span> : Ts: <span class="nb">set </span>temperature scale factor 
  <span class="o">[</span>-Tr&lt;val&gt;<span class="o">]</span> : Tr: <span class="nb">set </span>reduction factor, <span class="k">for</span> -C &lt;ireduction&gt;<span class="o">=</span>0 
  <span class="o">[</span>-T&lt;i1&gt;/&lt;i2&gt;/&lt;i3&gt;<span class="o">]</span>  : <span class="nb">set </span>terminal condition, have not implement
  <span class="o">[</span>-T&lt;n&gt;/&lt;m&gt;<span class="o">]</span>  : tune facor -T&lt;100.0&gt;/&lt;100.0&gt;  <span class="nv">n</span><span class="o">=</span>kf, <span class="nv">m</span><span class="o">=</span>tb/t
  <span class="o">[</span>-V<span class="o">]</span>  : Verbose mode will plot result after each circle
  <span class="o">[</span>-W&lt;mcmc_ratio&gt;<span class="o">]</span>  : Makov Chain Width
  <span class="o">[</span>-Z<span class="o">]</span>  : Layer model instead of halfspace
</pre></div>
</td></tr></table>


<p><strong> expected update: </strong></p>

<blockquote><p> for seismic data.</p></blockquote>

<p><strong> slipgen </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="bash">1
2
3
4
5
6
7</code></pre></div></td><td class="code"><div class="highlight"><pre>set_inversion_method slipgen  <span class="o">[</span>-K&lt;kvalue&gt;<span class="o">]</span> <span class="o">[</span>-P&lt;factor&gt;<span class="o">]</span> <span class="o">[</span>-R<span class="o">]</span> <span class="o">[</span>-W&lt;c<span class="p">|</span>e&gt;<span class="o">]</span> <span class="o">[</span>-G<span class="o">]</span> <span class="o">[</span>-S&lt;value&gt;<span class="o">]</span>
  <span class="o">[</span>-K&lt;1.0&gt;<span class="o">]</span>  : k^-2 parameter: <span class="o">(</span>0.0~1.0<span class="o">)</span>
  <span class="o">[</span>-P&lt;0.0&gt;<span class="o">]</span>  : rake perturbation factor: <span class="o">(</span>0.0~1.0<span class="o">)</span>
  <span class="o">[</span>-R<span class="o">]</span>       : texture risetime, auto-determined by moment distribution
  <span class="o">[</span>-W&lt;c&gt;<span class="o">]</span>    : save in which grid, c:cgrid, e:egrid
  <span class="o">[</span>-S&lt;0.5&gt;<span class="o">]</span>  : spike model, value spike_location
  <span class="o">[</span>-G<span class="o">]</span>       : random generator layout of derterminstic part 5X3 array
</pre></div>
</td></tr></table>


<p><strong> expected update: </strong></p>

<blockquote></blockquote>

<a name="inversion.flow"></a>
<h2>inversion flow</h2>

<p><strong>数据流</strong></p>

<ul>
<li><p>a example of dataflow: update_flow  <br/>
command: get_misfit. <br/>
update_misfits</p>

<blockquote><p>update_syn_probes</p>

<blockquote><p>update_syn_probes #</p>

<blockquote><p>update_database ? <br/>
 &nbsp;# <font color=red>update_source_distribution 和 update_database 应该兑换下位置.</font>   <br/>
 update_receivers   <br/>
 update_source_distribution <br/>
 &nbsp;# check inversion method. and invoke <strong>slip_distribution_ivnersion_wrap.</strong></p>

<blockquote><p> update_source_discrete       <br/>
 update_database</p></blockquote></blockquote></blockquote></blockquote></li>
<li><p>a example of dataflow: dirtyfy_flow <br/>
command: set_database  <br/>
dirtyfy_database</p>

<blockquote><p>dirtyfy_source_distribution</p>

<blockquote><blockquote><p>dirtyfy_syn_probes <br/>
dirtyfy_syn_probes.</p></blockquote></blockquote></blockquote></li>
</ul>


<p>1) set_inversion_method_vs</p>

<blockquote><p>调用: parse_inversion_params_wrap:   parse to structure ctrl and real array params <br/>
compare  params with ctrl_inversion%params_1 if not equal dirtyfy_source_distribution.</p></blockquote>

<p>2) slip_distribution_inversion_wrap</p>

<blockquote><p> 不检测数据流。</p></blockquote>

<p>slipgen 和 uniform 是伪反演。不需要obs data。直接texture moment.
给定moment，用来正演 syn data。
slipgen: 产生随机模型，用来测试其他方法
uniform：通过调用 lm, grid-search. 来正演， 断层参数</p>

<p>nnls，svd，sa，asa, baysian. 实际反演滑动分布。</p>

<table>
<thead>
<tr>
<th>method     </th>
<th style="text-align:left;"> info           </th>
<th> refs.</th>
</tr>
</thead>
<tbody>
<tr>
<td>uniform    </td>
<td style="text-align:left;"> &nbsp;         </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>slipgen    </td>
<td style="text-align:left;"> &nbsp;         </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>&nbsp;    </td>
<td style="text-align:left;"> &nbsp;         </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>nnls       </td>
<td style="text-align:left;"> seismic data.  </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>svd        </td>
<td style="text-align:left;"> geodetic data. </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>sa         </td>
<td style="text-align:left;"> joint.         </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>asa        </td>
<td style="text-align:left;"> joint.         </td>
<td> &nbsp;</td>
</tr>
<tr>
<td>baysian    </td>
<td style="text-align:left;"> joint.         </td>
<td> &nbsp;</td>
</tr>
</tbody>
</table>


<p><strong> psm_to_slip_distribution_slipgen </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</code></pre></div></td><td class="code"><div class="highlight"><pre>            
         <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">list_head</span> <span class="p">;</span> <span class="nv">i_sign</span><span class="o">=</span><span class="mi">1</span>
         <span class="k">do while</span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="nv">current_node</span><span class="p">))</span>
             <span class="nv">psm</span><span class="o">=&gt;</span><span class="nv">current_node</span><span class="p">%</span><span class="nv">psm</span>
             <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">current_node</span><span class="p">%</span><span class="nv">next</span>
             
             <span class="err">....</span>
         
             <span class="k">call </span><span class="nv">psm_transfer_params</span><span class="p">(</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span><span class="p">,</span><span class="nv">psm</span><span class="p">%</span><span class="nv">params</span><span class="p">,</span><span class="nv">i_sign</span><span class="p">)</span>  
             <span class="c">! i.e. copy psm%params =&gt;  psm_params_cache_eikonal_modify</span>
             
             <span class="nv">grid</span><span class="p">%</span><span class="nv">psm_sourcetype</span><span class="o">=</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span> 
             <span class="c">! save a copy to grid%psm_params</span>
             <span class="k">call </span><span class="nv">psm_transfer_params</span><span class="p">(</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span><span class="p">,</span><span class="nv">grid</span><span class="p">%</span><span class="nv">psm_params</span><span class="p">,</span><span class="o">-</span><span class="nv">i_sign</span><span class="p">)</span>
             
             <span class="err">...</span>

             <span class="k">call </span><span class="nv">psm_get</span><span class="p">(</span><span class="nv">psm</span><span class="p">,</span><span class="nv">rake</span><span class="o">=</span><span class="nv">rake0</span><span class="p">,</span><span class="nv">risetime</span><span class="o">=</span><span class="nv">risetime</span> <span class="p">)</span>

             <span class="err">...</span>
    
             <span class="k">call </span><span class="nv">texture_moment</span><span class="p">()</span>   <span class="err">#</span> <span class="nv">dummy</span> <span class="k">function</span>

<span class="k">             call </span><span class="nv">texture_slip_slipgen</span><span class="p">(</span><span class="nv">ctrl_slipgen</span><span class="p">%</span><span class="nv">sdin</span><span class="p">,</span><span class="nv">ctrl_slipgen</span><span class="p">%</span><span class="nv">kvalue</span><span class="p">)</span>
             <span class="k">call </span><span class="nv">texture_rake</span><span class="p">(</span><span class="nv">rake0</span><span class="p">)</span>
             <span class="k">call </span><span class="nv">texture_risetime</span><span class="p">(</span><span class="nv">risetime</span><span class="p">)</span><span class="c">! rake, risetime,moment.</span>
         <span class="k">end do</span>
</pre></div>
</td></tr></table>


<p><strong> psm_to_slip_distribution_uniform </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</code></pre></div></td><td class="code"><div class="highlight"><pre>            
        <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">list_head</span> <span class="p">;</span> <span class="nv">i_sign</span><span class="o">=</span><span class="mi">1</span>
         <span class="k">do while</span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="nv">current_node</span><span class="p">))</span>
             <span class="nv">psm</span><span class="o">=&gt;</span><span class="nv">current_node</span><span class="p">%</span><span class="nv">psm</span>
             <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">current_node</span><span class="p">%</span><span class="nv">next</span>
             <span class="nv">grid</span><span class="o">=&gt;</span><span class="nv">psm</span><span class="p">%</span><span class="nv">cgrid</span>
             
             <span class="k">call </span><span class="nv">psm_transfer_params</span><span class="p">(</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span><span class="p">,</span><span class="nv">psm</span><span class="p">%</span><span class="nv">params</span><span class="p">,</span><span class="nv">i_sign</span><span class="p">)</span> 
             <span class="c">! update specific params structure</span>
             
             <span class="nv">grid</span><span class="p">%</span><span class="nv">psm_sourcetype</span><span class="o">=</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span> 
             <span class="c">! save a copy to grid%psm_params</span>
             <span class="k">call </span><span class="nv">psm_transfer_params</span><span class="p">(</span><span class="nv">psm</span><span class="p">%</span><span class="nv">sourcetype</span><span class="p">,</span><span class="nv">grid</span><span class="p">%</span><span class="nv">psm_params</span><span class="p">,</span><span class="o">-</span><span class="nv">i_sign</span><span class="p">)</span>
             
             <span class="k">call </span><span class="nv">texture_moment</span><span class="p">()</span>   <span class="err">#</span> <span class="nv">dummy</span> <span class="k">function </span>
<span class="k">                </span>
<span class="k">         end do</span>
</pre></div>
</td></tr></table>


<p><strong> psm_to_slip_distribution_nnls </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</code></pre></div></td><td class="code"><div class="highlight"><pre>            
       <span class="c">! count  Number of discrete-source</span>
        <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">list_head</span> <span class="p">;</span> <span class="nv">is</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">i_sign</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">do while</span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="nv">current_node</span><span class="p">))</span>
           <span class="err">...</span>
       <span class="nv">is</span><span class="o">=</span><span class="nv">is</span><span class="o">+</span><span class="mi">1</span>
           <span class="err">...</span>
        <span class="k">end do</span>  <span class="c">! while</span>

       <span class="c">! count Number of obs data.</span>
        <span class="k">do </span><span class="nv">ireceiver</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nv">nreceivers</span><span class="err">.</span>
           <span class="nv">nobs</span> <span class="o">=</span> <span class="nv">nobs</span> <span class="o">+</span> <span class="nv">span_ref</span><span class="o">/</span><span class="nv">delta</span> 
        <span class="k">end do</span> 
       
       <span class="c">! allocate memory  Ax=B </span>
          <span class="k">allocate</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">X</span><span class="p">,</span> <span class="err">...</span><span class="p">)</span> 
           
       <span class="c">! calculate green A.</span>
          <span class="nv">make_seismogram</span><span class="p">(</span><span class="nv">sub_tdsm</span><span class="p">,</span> <span class="err">...</span> <span class="p">)</span>
       
       <span class="c">! calculate obs B</span>
          <span class="nv">B</span><span class="p">(</span><span class="nv">i</span><span class="p">:</span><span class="nv">j</span><span class="p">)</span><span class="o">=</span><span class="nv">strip</span><span class="p">%</span><span class="k">data</span><span class="p">(</span><span class="nv">i</span><span class="p">&amp;</span><span class="nv">prime</span><span class="p">;:</span><span class="nv">j</span><span class="p">&amp;</span><span class="nv">prime</span><span class="p">;)</span>
          
       <span class="c">! set_constrains</span>
          <span class="err">....</span> 
       
       <span class="c">! invoke</span>
         <span class="k">call </span><span class="nv">nnls</span><span class="p">(</span><span class="err">...</span><span class="p">)</span>

       <span class="c">! deallocate memory.</span>
         <span class="err">....</span>
       
       <span class="c">! save result.</span>
         <span class="err">....</span>
</pre></div>
</td></tr></table>


<p><strong> psm_to_slip_distribution_svd </strong></p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</code></pre></div></td><td class="code"><div class="highlight"><pre>            
      <span class="c">! count  Number of discrete-source</span>
        <span class="nv">current_node</span><span class="o">=&gt;</span><span class="nv">list_head</span> <span class="p">;</span> <span class="nv">is</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">i_sign</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">do while</span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="nv">current_node</span><span class="p">))</span>
           <span class="err">...</span>
       <span class="nv">is</span><span class="o">=</span><span class="nv">is</span><span class="o">+</span><span class="mi">1</span>
           <span class="err">...</span>
        <span class="k">end do</span>  <span class="c">! while</span>

       <span class="c">! count N-obs</span>
         <span class="nv">nobs</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">ndataset</span><span class="o">=</span><span class="nv">size</span><span class="p">(</span><span class="nv">obs_datasets</span><span class="p">)</span>
         <span class="k">do </span><span class="nv">loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">ndataset</span>
            <span class="nv">nobs</span><span class="o">=</span><span class="nv">nobs</span><span class="o">+</span><span class="nv">size</span><span class="p">((</span><span class="nv">obs_datasets</span><span class="p">(</span><span class="nv">loop</span><span class="p">)%</span><span class="nv">obs</span><span class="p">))</span>
         <span class="k">end do</span>
         
       <span class="c">! allocate memory</span>
         <span class="k">allocate</span><span class="p">(</span><span class="nv">AA</span><span class="p">,</span><span class="nv">BB</span><span class="p">,</span><span class="nv">XX</span><span class="p">,</span><span class="nv">DD</span> <span class="err">...</span><span class="p">)</span> 
       
       <span class="c">! construct AA ... DD ...</span>
         <span class="err">....</span> 
       
       <span class="c">! call SVD</span>
         <span class="err">....</span>

       <span class="c">! deallocate momery</span>
         <span class="err">....</span>
        
       <span class="c">! save result</span>
         <span class="err">....</span>
</pre></div>
</td></tr></table>


<p><strong> psm_to_slip_distribution_sa1 </strong></p>

<p><strong> psm_to_slip_distribution_baysian </strong></p>

<hr />

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="fortran"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</code></pre></div></td><td class="code"><div class="highlight"><pre>            
<span class="k">subroutine </span><span class="nv">calculate_and_scale_seismogram</span><span class="p">()</span>
   <span class="nv">delta</span><span class="p">:</span>
      <span class="nv">db</span><span class="p">%</span><span class="nv">dt</span><span class="p">,</span> 

   <span class="nv">receiver</span><span class="kd">::</span> 
      <span class="k">type</span><span class="p">(</span><span class="nv">t_receiver</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">receivers</span> <span class="err">{</span>   <span class="c">!   receiver.f90</span>
         <span class="k">type</span><span class="p">(</span><span class="nv">t_strip</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:)</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">displacement</span> <span class="err">{</span>    <span class="c">! sparse_trace.f90</span>
              <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nv">real_kind</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="k">data</span>     
         <span class="err">}</span>
      <span class="err">}</span> 
   <span class="c">!-----------------------------------------------------------------------------------------------------------------</span>
   <span class="c">!             real, dimension(:) :: [t_receiver :: receivers](ireceiver)%[t_strip displacement](icomponent)%data</span>
   <span class="c">!   should update_to:  </span>
   <span class="c">!             real, dimension(:) :: [t_receiver :: receivers](ireceiver)%[t_trace :: traces](r,t,z,BHZ,BHN,...)%[t_strip :: strips](istrip)data</span>
   <span class="c">!-----------------------------------------------------------------------------------------------------------------</span>
   
   <span class="c">! source ::</span>
     <span class="k">type</span><span class="p">(</span><span class="nv">t_list_node</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="nv">current_node</span> <span class="o">=</span> <span class="nv">list_head</span>  <span class="err">{</span>
         <span class="k">type</span><span class="p">(</span><span class="nv">t_list_node</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="nv">next</span><span class="o">=&gt;</span><span class="nv">NULL</span><span class="p">()</span>
         <span class="k">type</span><span class="p">(</span><span class="nv">t_psm</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">psm</span>  <span class="err">{</span>
              <span class="k">type</span><span class="p">(</span><span class="nv">t_eikonal_grid</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">egrid</span> <span class="err">{</span>
                  <span class="nv">grid</span><span class="p">%</span><span class="nv">moments</span><span class="p">(</span><span class="nv">nsd</span><span class="p">,</span><span class="nv">nx</span><span class="p">,</span><span class="nv">ny</span><span class="p">,</span><span class="nv">nw</span><span class="p">)</span>
              <span class="err">}</span>
              <span class="k">type</span><span class="p">(</span><span class="nv">t_eikonal_grid</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">cgrid</span>
         <span class="err">}</span>
         <span class="kt">logical</span> <span class="kd">::</span> <span class="nv">xxx_dirty</span><span class="p">,</span><span class="nv">xxx_inited</span>
     <span class="err">}</span>
   <span class="c">!---------------------------------------------------------------------------------------</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">ctrl_inversion</span><span class="p">%</span><span class="nv">imethod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="nv">slip_inversion_method_slipgen</span><span class="p">)</span> <span class="k">then</span>
<span class="k">       if</span><span class="p">(</span><span class="ow">.not.</span><span class="nv">ctrl_slipgen</span><span class="p">%</span><span class="nv">cgrid</span><span class="p">)</span> <span class="nv">grid</span><span class="o">=&gt;</span><span class="nv">psm</span><span class="p">%</span><span class="nv">egrid</span>   <span class="c">! slipgen may save result in find grid          </span>
   <span class="k">end if</span>
   <span class="c">!---------------------------------------------------------------------------------------</span>
   <span class="nv">grid</span><span class="o">=&gt;</span><span class="nv">cgrid</span> <span class="nb">or  </span><span class="nv">grid</span><span class="o">=&gt;</span><span class="nv">egrid</span>  
   
<span class="c">! info:  step_1: if cgrid%duration &gt; effective_dt.  then discretize each subfault to several part. </span>
<span class="c">! info:  step_2: apply risetime</span>
<span class="c">! info:  step_3:      </span>
<span class="err">{</span> 
   <span class="k">do </span><span class="nv">iy</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nv">ny</span><span class="p">,</span><span class="nv">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nv">nx</span>

      <span class="c">! step_1:</span>
        <span class="nv">duration</span><span class="o">=</span><span class="nv">grid</span><span class="p">%</span><span class="nv">durations</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">)</span> <span class="p">;</span> <span class="nv">egrid</span><span class="p">%</span><span class="nv">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="nv">cgrid</span><span class="p">%</span><span class="nv">duration</span>
        <span class="k">call </span><span class="nv">discretize_subfault_time</span><span class="p">(</span> <span class="nv">duration</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="nv">effective_dt</span><span class="p">,</span> <span class="nv">t_weights</span><span class="p">,</span> <span class="nv">t_offsets</span><span class="p">,</span><span class="nv">nsrc</span><span class="p">)</span>    <span class="c">! rectangular</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">sub_tdsm</span><span class="p">%</span><span class="nv">centroids</span><span class="p">(</span><span class="nv">nsrc</span><span class="p">))</span>

      <span class="c">! step_2:</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">ctrl_inversion</span><span class="p">%</span><span class="nv">imethod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="nv">slip_inversion_method_nnls</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! n triangular stf</span>
                        <span class="k">call </span><span class="nv">discretize_subfault_time</span><span class="p">(</span><span class="nv">risetime</span><span class="p">,</span>  <span class="nv">deltat</span><span class="p">,</span> <span class="nv">tweights</span><span class="p">,</span> <span class="nv">toffsets</span><span class="p">,</span><span class="nv">nt</span><span class="p">)</span> <span class="c">! for strip_fold</span>
        <span class="k">else</span>  <span class="c">! one rectangular stf( source time function )</span>
                        <span class="k">call </span><span class="nv">discretize_subfault_time</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="nv">risetime</span><span class="p">,</span>  <span class="nv">deltat</span><span class="p">,</span> <span class="nv">tweights</span><span class="p">,</span> <span class="nv">toffsets</span><span class="p">,</span><span class="nv">nt</span><span class="p">)</span> <span class="c">! for strip_fold </span>
        <span class="k">end if</span>

      <span class="c">! step_3: </span>
             <span class="k">forall</span><span class="p">(</span><span class="nv">it</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nv">nsrc</span><span class="p">)</span> <span class="c">! same geocoordinate.</span>
                        <span class="nv">sub_tdsm</span><span class="p">%</span><span class="nv">centroids</span><span class="p">(</span><span class="nv">it</span><span class="p">)%</span><span class="nv">north</span> <span class="o">=</span> <span class="nv">grid</span><span class="p">%</span><span class="nv">points</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">)</span>
                        <span class="nv">sub_tdsm</span><span class="p">%</span><span class="nv">centroids</span><span class="p">(</span><span class="nv">it</span><span class="p">)%</span><span class="nv">east</span>  <span class="o">=</span> <span class="nv">grid</span><span class="p">%</span><span class="nv">points</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">)</span>
                        <span class="nv">sub_tdsm</span><span class="p">%</span><span class="nv">centroids</span><span class="p">(</span><span class="nv">it</span><span class="p">)%</span><span class="nv">depth</span> <span class="o">=</span> <span class="nv">grid</span><span class="p">%</span><span class="nv">points</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">)</span>
             <span class="k">end forall</span>
<span class="k">             </span>
<span class="k">             </span>
<span class="k">          do </span><span class="nv">iw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">nw</span> <span class="c">! asa,slipgen,uniform:  nw=svd =1,   mtw: nw &gt;= 1</span>
                        <span class="c">!print *, &#39;debug minimizer_engine.f90 1566 iw&#39;,iw</span>
              <span class="k">FORALL</span><span class="p">(</span><span class="nv">it</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nv">nsrc</span><span class="p">)</span> <span class="nv">sub_tdsm</span><span class="p">%</span><span class="nv">centroids</span><span class="p">(</span><span class="nv">it</span><span class="p">)%</span><span class="nb">time</span>  <span class="o">=</span>  <span class="p">&amp;</span>
                        <span class="nv">grid</span><span class="p">%</span><span class="nv">times</span><span class="p">(</span><span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>  <span class="c">! times reference, relative time</span>
                        <span class="nv">origin_time</span><span class="o">-</span><span class="nv">grid</span><span class="p">%</span><span class="nv">center_time</span>  <span class="o">+</span> <span class="p">&amp;</span> <span class="c">! due to origin%(time,x,y,z)  is centeroid location</span>
                        <span class="nv">t_offsets</span><span class="p">(</span><span class="nv">it</span><span class="p">)</span>       <span class="o">+</span> <span class="p">&amp;</span> <span class="c">! offset by nsrc        </span>
                        <span class="p">(</span><span class="nv">iw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="nv">risetime</span> <span class="o">+</span> <span class="p">&amp;</span> <span class="c">! offset by nw</span>
                        <span class="kt">real</span><span class="p">(</span><span class="nv">psm</span><span class="p">%</span><span class="nv">ref_time</span><span class="p">)</span>   <span class="c">! new ref scheme</span>
          <span class="k">end do</span>

<span class="k">   end do</span>
<span class="err">}</span>


<span class="k">end subroutine</span>
</pre></div>
</td></tr></table>


<a name="shortest_doi"></a>
<h2>shortest_doi</h2>

<p>&hellip;</p>

<a name="cgrid.....egrid"></a>
<h2>cgrid 和 egrid</h2>

<p> egrid:
 cgrid:</p>

<a name="time.reference"></a>
<h2>time reference</h2>

<pre><code class="brush: fortran;  toolbar: false; gutter:false; class-name: "shbg";">psm {
   psm%ref_time &lt;= suppose to be centroid time
   psm%grid {
       psm%grid%center_time=0.0    &lt;=  centroid_time: ref_point is eipcenter
                                       inversed from uniform moments distribution by kiwi tool,
                                       despite of uniform or non-uniform distribution.
       psm%grid%time(ix,iy)=0.0    &lt;=  solve by eikonal equation,  ref_point is  "psm%grid%initialpoint"

   }
}


set_source_location -F&lt;n&gt; -L&lt;lat&gt;/&lt;lon&gt;  -T&lt;ref_time&gt;    
set_source_params source_eikonal_modify  -R&lt;t0&gt;/&lt;x&gt;/&lt;y&gt;/&lt;z&gt;  
                                         -M&lt;m&gt;/&lt;strike0&gt;[:&lt;strike1&gt;]/&lt;dip0&gt;[:&lt;dip1&gt;]/&lt;rake&gt;]  
                                         -H&lt;nukl-shift-x/nukl-shift-y&gt;[c|r]   
                                         ....



sub_tdsm%centroids(it)%time  =  real(psm%ref_time)   &amp;  ! set_source_location `[-T&lt;ref&gt;]`                                    origin of coordinate system.
                             +  origin_time          &amp;  ! set_source_params source_eikonal_modify  `[-R&lt;t0&gt;[/&lt;x&gt;/&lt;y&gt;/&lt;z&gt;]]`  origin of coordinate on fault on fault.
                             -  grid%center_time     &amp;  ! time diff between center_point and hypocenter.                   
                             +  grid%times(ix,iy)    &amp;  ! time diff reference, relative time                                
                             +  (iw-1)*0.5*risetime  &amp;  ! offset by nw
                             +  t_offsets(it)        &amp;  ! offset by nsrc
                             +  (iw-1)*0.5*risetime  &amp;  ! offset by nw
</code></pre>

<p>Notes:</p>

<blockquote><p>kiwi tool  <code>set_source_params -R&lt;t0&gt;/&lt;x&gt;/&lt;y&gt;/&lt;z&gt; ...</code> is the coordinate of <strong>center_point</strong>. so we need to subtract the grid%center_time.
in fact <code>-R&lt;t0&gt;/&lt;x&gt;/&lt;y&gt;/&lt;z&gt;</code>  where <code>&lt;t0&gt;</code> and <code>&lt;x/y/z&gt;</code>  is independent coordinate, can be seprate to conect to different point. For example:
<code>&lt;t0&gt;</code> be the coordinate of hypocenter or centroid point.  In order to keep consistent with kiwi tool. so suppose it be the center point.</p></blockquote>

      
      <footer>
        <p>
          本作品由 <a href="mailto:wzjwzj@mail.ustc.edu.cn" rel="nofollow">孤月谁明</a> 创作，采用
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="查看协议详细信息" target="_blank">CC BY-NC-SA 3.0 许可协议</a>
          进行许可。
        </p>
      </footer>
      
    </section>

  </article>
</section>

<section>

  
  <ul class="tag-box inline">
    <li><i class="fa fa-folder-open fa-4"></i></li>
    
    


  
     
    	<li><a href="/categories.html#uncategorized-ref" rel="nofollow">
    		uncategorized <span>8</span>
    	</a></li>
    
  


  </ul>
  

  
  <ul class="tag-box inline">
    <li><i class="fa fa-tags fa-4"></i></li>
    
    


  
     
    	<li><a href="/tags.html#info-ref" rel="nofollow">info <span>11</span></a></li>
    
  



  </ul>
  

  <div class="pagination">
    <ul>
      
      <li class="prev"><a href="/blog/2014/01/14/smalltool" title="small tools,widgets or applets list">&larr; 上一篇</a></li>
      
      <li><a href="/archive.html" rel="nofollow">文章列表</a></li>
      
      <li class="next"><a href="/blog/2014/02/08/nationalparks-in-deutschland" title="测试谷歌地图:德国国家公园">下一篇 &rarr;</a></li>
      
    </ul>
  </div>

</section>

<section id="comments">
  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'guyueshuiming'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var dsc = document.createElement('script'); dsc.type = 'text/javascript'; dsc.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        dsc.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(dsc);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</section>


        </div>
      </div>
      
      <div id="back-top">
  <a href="#top" title="回到顶部"></a>
</div>
<script type="text/javascript">
$("#back-top").hide();
$(document).ready(function () {
  $(window).scroll(function () {
    if ($(this).scrollTop() > 100) {
      $('#back-top').fadeIn();
    } else {
      $('#back-top').fadeOut();
    }
  });
  $('#back-top a').click(function () {
    $('body,html').animate({
      scrollTop: 0
    }, 800);
    return false;
  });
});
</script>

    </section>

    <footer id="bottom">
      <p align="center">&copy; 2014 guyueshuiming
        with help from <a href="http://jekyllbootstrap.com" target="_blank" rel="nofollow" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        and <a href="http://twitter.github.com/bootstrap/" target="_blank" rel="nofollow">Twitter Bootstrap</a>
      </p>
    </footer>
  </div>




<!-- fixed toc or fix container -->

<script type="text/javascript">
   $(document).ready(function(){
   
      var f= $('#fixed-container') ;
   

   f.css({ 'z-index':'99999'});
   var h= f.height();
   var position = f.offset();

   $(window).scroll(function() {
      if($(window).scrollTop() > position.top ) {
         v = 129 + h - $(window).innerHeight()  ;
         u = $( document ).height()-$(window).scrollTop()-$(window).innerHeight();
         if( v > 0 && u < h && u < v ) {
            f.css('position','fixed').css('top',-(u+v));
         } else {
            f.css('position','fixed').css('top', -1);
         }
      } else {
       f.css('position','static');
      }
   });
   if(matchMedia) {
     var mq = matchMedia('(max-width: 999px)');
     mq.addListener(function(mql) {
       if (!mql.matches) {
         position = f.offset();
       }
     });
   }
});
</script>

<script type="text/javascript">
  $(document).ready(function() {
    $("table.highlighttable").wrap('<div style="overflow:auto;border: 1px solid rgba(0,0,0,0.15);border-radius: 4px;"></div>');
    /*$('pre:not(table.highlighttable pre, div.highlight pre, div.gist pre, pre.plain)').addClass('prettyprint linenums').attr('style', 'overflow:auto'); 
      $.getScript('/assets/prettify/prettify.js',function(){ prettyPrint();});*/
    $("#icon-resize").click(function(){
      if($(this).hasClass("fa-expand")){
         $(this).removeClass("fa-expand");
         $(this).addClass("fa-compress");
	 $("#wrap").css("width","100%");
      } else{
         $(this).removeClass("fa-compress");
         $(this).addClass("fa-expand");
	 $("#wrap").css("width","1000px");
      }
     });
     
     /*$('pre>code').each(function(){
	$(this).parent().attr("class",$(this).attr("class"));
	$(this).parent().html($(this).html());
     });*/
     $('section>pre>code').unwrap();
     SyntaxHighlighter.config.tagName="code";	
     SyntaxHighlighter.all();
     	
  });
</script>

<script src="/assets/themes/twitter/js/hc.js" type="text/javascript"></script>
<!--script src="http://dict.cn/hc/" type="text/javascript"></script-->
<script type="text/javascript">
dictInit();
</script>
</body>
</html>

